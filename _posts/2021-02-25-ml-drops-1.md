---
layout: post
title: ML Drops v1
subtitle: Feliz Aniversário, AWS Cloudformation.
tags: [aws, mlops, cloudformation, iaac, iac]
comments: true
draft: true
---

Hoje, dia 25 de fevereiro, o serviço [AWS Cloudformation completa 10 anos](https://aws.amazon.com/pt/about-aws/whats-new/2011/02/25/introducing-aws-cloudformation/)!

<p style="text-align: center"><img src="https://i.imgur.com/MsaN5cz.png"></p>

Através dos *templates* do Cloudformation somos capazes de provisionar nossa infraestrutura como código, garantindo mantenabilidade, versionamento e reaproveitamento.

```yaml
AWSTemplateFormatVersion: 2010-09-09
Parameters:
  BucketName:
    Type: String
    Description: 'The name of the S3 Bucket to create, make this unique'
Resources:
  S3BUCKET:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Ref BucketName
```
<p style="text-align: center; margin: 0">Exemplo de template de cloudformation para criação de um bucket S3.</p>

Para comemorar essa marca, **listamos 10 dicas e curiosidades sobre este serviço**.

## DependsOn

Ao adicionar a chave `DependsOn` em um recurso, garantimos que aquele recurso só será executado após um outro recurso ser instanciado.

```yaml
AWSTemplateFormatVersion: 2010-09-09
Resources:
  BucketOne:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Ref BucketName1
  BucketTwo:
    DependsOn: BucketOne  # O BucketTwo inicia somente após o BucketOne 
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Ref BucketName2
```
<br>

## Cfn-Lint

O pacote python [`cfn-lint`](https://pypi.org/project/cfn-lint/) fornece um validador para *templates* de cloudformation, informando possíveis erros e falhas de construção.

```sh
$ cfn-lint template.yml

E3002 Invalid Property Resources/Function/Properties/Packagetype
template.yml:12:7
```

<br>

## Stack Sets

Precisa executar seu cloudformation em diferentes contas da AWS? Você precisa conhecer as [`stack sets`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-concepts.html).

```sh
aws cloudformation create-stack-set \ 
      --stack-set-name StackSet_myApp \
      --template-url file://template.yaml \
      --permission-model SERVICE_MANAGED 
      --auto-deployment Enabled=true

aws cloudformation create-stack-instances \
      --stack-set-name StackSet_myApp 
      --accounts 123456789012 223456789012 \
      --regions '["eu-west-1"]'
```

<br>

## Cloudformation Registry

Quer inspiração na hora de provisionar seus recursos com Cloudformation? Acesse o [Cloudformation Registry](https://www.google.com/search?channel=fs&client=ubuntu&q=cloudformation+registry) e tenha acesso a dezenas de exemplos da AWS, ou crie seu próprio registry e compartilhe com seus colegas.

<p style="text-align: center"><img src="https://i.imgur.com/v1HGHdD.png"></p>

<br>

## Pseudo-Parâmetros

Não quer escrever o Id da sua conta no código, ou quer generalizar ele para outras regiões? O AWS Cloudformation disponibiliza os [pseudo-parâmetros](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/pseudo-parameter-reference.html), um grupo de variáveis que são resolvidas em tempo de execução.

```yaml
Outputs:
  StackNameRegion:
    Value: !Sub "Stack-${AWS::AccountId}-${AWS::Region}"
```

<br>

## Drift Detection

Sabe aquela EC2 que você jurou ter provisionado via Cloudformation, mas quando abre o console não encontra mais?

É ai que o **Drift Detection** entra em ação, esta funcionalidade nos ajuda a identificar se modificações em sua *Stack* foram realizadas de forma manual.

Este recurso pode ser utilizado via CLI, conforme mostrado abaixo.

```console
$ aws cloudformation detect-stack-drift \
    --stack-name NomeStack

{
    "StackDriftDetectionId": "1a229160-e4d9-xmpl-ab67-0a4f93df83d4"
}
```
Obtendo o `StackDriftDetectionId`, podemos executar o comando `describe-stack-resource-drifts` e verificar os recursos modificados.

```console
$ aws cloudformation describe-stack-resource-drifts \
    --stack-name NomeStack
```
<br>

## SAM

Esta é uma extensão do Cloudformation focada principalmente no provisionamento de serviços *serverless*.

Utilizando esta extensão, o provisionamento de recursos *serverless* fica mais claro e melhor organizado em sua `Stack` de Cloudformation, além de possuir um CLI dedicado.

Abaixo, temos um exemplo de um template SAM. Note que a mudança principal é na primeira linha com o `Transform`.

```yaml
Transform: AWS::Serverless-2016-10-31
Globals:
  set of globals
Description:
  String
Metadata:
  template metadata
Parameters:
  set of parameters
Mappings:
  set of mappings
Conditions:
  set of conditions
Resources:
  set of resources
Outputs:
  set of outputs
```

## Custom Modules

## Helper Scripts

## Não esqueça de executar seus `change sets`