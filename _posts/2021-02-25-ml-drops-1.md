---
layout: post
title: ML Drops v1
subtitle: Feliz Aniversário, AWS Cloudformation.
tags: [aws, mlops, cloudformation, iaac, iac]
comments: true
draft: true
---

Dia 25 de fevereiro, hoje o serviço [AWS Cloudformation completa 10 anos](https://aws.amazon.com/pt/about-aws/whats-new/2011/02/25/introducing-aws-cloudformation/)!

Através dos *templates* do Cloudformation somos capazes de provisionar nossa infraestrutura como código, garantindo mantenabilidade, versionamento e reaproveitamento.

```yaml
AWSTemplateFormatVersion: 2010-09-09
Parameters:
  BucketName:
    Type: String
    Description: 'The name of the S3 Bucket to create, make this unique'
Resources:
  S3BUCKET:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Ref BucketName
```
<p style="text-align: center">Exemplo de template de cloudformation para criação de um bucket S3</p>

Para comemorar essa marca, **listamos 10 dicas e curiosidades sobre este serviço**.

## DependsOn

Ao adicionar a chave `DependsOn` em um recurso, garantimos que aquele recurso só será executado após um outro recursos ser instanciado.

```yaml
AWSTemplateFormatVersion: 2010-09-09
Resources:
  BucketOne:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Ref BucketName1
  BucketTwo:
    DependsOn: BucketOne  # O BucketTwo inicia somente após o BucketOne 
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Ref BucketName2
```

## Cfn-Lint

O pacote python [`crn-lint`](https://pypi.org/project/cfn-lint/) fornece um validador para *templates* de cloudformation, informando possíveis erros e falhas de construção.

```sh
$ cfn-lint template.yml

E3002 Invalid Property Resources/Function/Properties/Packagetype
infra/lambda.yml:12:7
```

## Stack Sets

Precisa executar em seu cloudformation em diferentes contas da AWS? Você precisa conhecer as [`stack sets`](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-concepts.html).

```sh
aws cloudformation create-stack-set \ 
      --stack-set-name StackSet_myApp \
      --template-url file://template.yaml \
      --permission-model SERVICE_MANAGED 
      --auto-deployment Enabled=true

aws cloudformation create-stack-instances \
      --stack-set-name StackSet_myApp 
      --accounts 123456789012 223456789012 \
      --regions '["eu-west-1"]'
```

## Cloudformation Registry

Quer inspiração na hora de provisionar seus recursos com Cloudformation? 




## Drift Detection

```yaml
Outputs:
  StackNameRegion:
    Value: !Sub "Stack-${AWS::AccountId}-${AWS::Region}"
```

<br>

## Drift Detection

Sabe aquela EC2 que você jurou ter provisionado via Cloudformation, mas quando abre o console não encontra mais?

É ai que o **Drift Detection** entra em ação, esta funcionalidade nos ajuda a identificar se modificações em sua *Stack* foram realizadas de forma manual.

Este recurso pode ser utilizado via CLI, conforme mostrado abaixo.

```console
$ aws cloudformation detect-stack-drift \
    --stack-name NomeStack

{
    "StackDriftDetectionId": "1a229160-e4d9-xmpl-ab67-0a4f93df83d4"
}
```
Obtendo o `StackDriftDetectionId`, podemos executar o comando `describe-stack-resource-drifts` e verificar os recursos modificados.

```console
$ aws cloudformation describe-stack-resource-drifts \
    --stack-name NomeStack
```
<br>

## SAM

Esta é uma extensão do Cloudformation focada principalmente no provisionamento de serviços *serverless*.

Utilizando esta extensão, o provisionamento de recursos *serverless* fica mais claro e melhor organizado em sua `Stack` de Cloudformation, além de possuir um CLI dedicado.

Abaixo, temos um exemplo de um template SAM. Note que a mudança principal é na primeira linha com o `Transform`.

```yaml
Transform: AWS::Serverless-2016-10-31
Globals:
  set of globals
Description:
  String
Metadata:
  template metadata
Parameters:
  set of parameters
Mappings:
  set of mappings
Conditions:
  set of conditions
Resources:
  set of resources
Outputs:
  set of outputs
```

## Modules
Lançado em novembro de 2020, os módulos do Cloudformation devem ser utilizados quando queremos reutilizar nossos templates em diferentes Stacks de Cloudformation.

Dessa forma, os módulos que criamos devem ser usado como um `native resource` do Cloudformation.

Esses mmódulos podem conter melhores praticas de instancias EC2, configurações padrões de SQS, diretivas de segurança para EBS.

Neste [link](https://aws.amazon.com/pt/blogs/mt/introducing-aws-cloudformation-modules/) tem um exemplo bem legal de seu utilizar módulos no [S3](https://aws.amazon.com/pt/s3/).

## Helper Scripts

Os script's auxiliares do Cloudformation são muito legais quando utilizados para gerenciamento de metadados dos seus recursos provisionados, sincronização de recursos ou até mesmo realizar verificações de atualizações.

abaixo listamos os 4 principais **Helpers Scripts** e os respectivos links para acesso

* [`cfn-init`](https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/cfn-init.html)
* [`cfn-signal`](https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/cfn-signal.html)
* [`cfn-get-metadata`](https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/cfn-get-metadata.html)
* [`cfn-hup`](https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/cfn-hup.html)

## Pseudo-Parâmetros




## Não esqueça de executar seus `change sets`